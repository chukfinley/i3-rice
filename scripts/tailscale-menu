#!/bin/bash
# Tailscale/Mullvad VPN Menu

# Get current exit node status
get_exit_node() {
    # Method 1: Check ExitNodeStatus
    local node=$(tailscale status --json 2>/dev/null | jq -r '
        if .ExitNodeStatus.Online == true then
            (.Peer // {}) | to_entries[] |
            select(.value.ExitNode == true) |
            .value.HostName
        else
            empty
        end
    ' 2>/dev/null)

    # Method 2: Check Peer with ExitNode=true
    if [[ -z "$node" ]]; then
        node=$(tailscale status --json 2>/dev/null | jq -r '
            (.Peer // {}) | to_entries[] |
            select(.value.ExitNode == true) |
            .value.HostName
        ' 2>/dev/null)
    fi

    # Method 3: Check debug prefs
    if [[ -z "$node" ]]; then
        local exit_id=$(tailscale debug prefs 2>/dev/null | grep '"ExitNodeID"' | grep -v '""' | head -1)
        if [[ -n "$exit_id" && "$exit_id" != *'""'* ]]; then
            node="connected"
        fi
    fi

    echo "$node"
}

# Connect to a server
connect_server() {
    local country="$1"
    local SERVER=$(tailscale exit-node list 2>/dev/null | grep -i "mullvad" | grep -i "$country" | shuf -n1 | awk '{print $1}')
    if [[ -n "$SERVER" ]]; then
        tailscale set --exit-node="$SERVER"
        notify-send "VPN" "Connecting to $country..." -t 2000
    else
        notify-send "VPN" "No server found for $country" -t 2000
    fi
}

# Disconnect
disconnect_vpn() {
    tailscale set --exit-node=""
    notify-send "VPN" "Disconnected" -t 2000
}

# Get all available countries
show_all_servers() {
    COUNTRIES=$(tailscale exit-node list 2>/dev/null | grep -i "mullvad" | awk '{print $4}' | sort -u | while read country; do
        case "$country" in
            Albania) echo "ðŸ‡¦ðŸ‡± Albania" ;;
            Argentina) echo "ðŸ‡¦ðŸ‡· Argentina" ;;
            Australia) echo "ðŸ‡¦ðŸ‡º Australia" ;;
            Austria) echo "ðŸ‡¦ðŸ‡¹ Austria" ;;
            Belgium) echo "ðŸ‡§ðŸ‡ª Belgium" ;;
            Brazil) echo "ðŸ‡§ðŸ‡· Brazil" ;;
            Bulgaria) echo "ðŸ‡§ðŸ‡¬ Bulgaria" ;;
            Canada) echo "ðŸ‡¨ðŸ‡¦ Canada" ;;
            Chile) echo "ðŸ‡¨ðŸ‡± Chile" ;;
            Colombia) echo "ðŸ‡¨ðŸ‡´ Colombia" ;;
            Croatia) echo "ðŸ‡­ðŸ‡· Croatia" ;;
            Czechia|Czech) echo "ðŸ‡¨ðŸ‡¿ Czechia" ;;
            Denmark) echo "ðŸ‡©ðŸ‡° Denmark" ;;
            Estonia) echo "ðŸ‡ªðŸ‡ª Estonia" ;;
            Finland) echo "ðŸ‡«ðŸ‡® Finland" ;;
            France) echo "ðŸ‡«ðŸ‡· France" ;;
            Germany) echo "ðŸ‡©ðŸ‡ª Germany" ;;
            Greece) echo "ðŸ‡¬ðŸ‡· Greece" ;;
            "Hong") echo "ðŸ‡­ðŸ‡° Hong Kong" ;;
            Hungary) echo "ðŸ‡­ðŸ‡º Hungary" ;;
            Iceland) echo "ðŸ‡®ðŸ‡¸ Iceland" ;;
            India) echo "ðŸ‡®ðŸ‡³ India" ;;
            Indonesia) echo "ðŸ‡®ðŸ‡© Indonesia" ;;
            Ireland) echo "ðŸ‡®ðŸ‡ª Ireland" ;;
            Israel) echo "ðŸ‡®ðŸ‡± Israel" ;;
            Italy) echo "ðŸ‡®ðŸ‡¹ Italy" ;;
            Japan) echo "ðŸ‡¯ðŸ‡µ Japan" ;;
            Latvia) echo "ðŸ‡±ðŸ‡» Latvia" ;;
            Luxembourg) echo "ðŸ‡±ðŸ‡º Luxembourg" ;;
            Malaysia) echo "ðŸ‡²ðŸ‡¾ Malaysia" ;;
            Mexico) echo "ðŸ‡²ðŸ‡½ Mexico" ;;
            Moldova) echo "ðŸ‡²ðŸ‡© Moldova" ;;
            Netherlands) echo "ðŸ‡³ðŸ‡± Netherlands" ;;
            "New") echo "ðŸ‡³ðŸ‡¿ New Zealand" ;;
            Nigeria) echo "ðŸ‡³ðŸ‡¬ Nigeria" ;;
            Norway) echo "ðŸ‡³ðŸ‡´ Norway" ;;
            Poland) echo "ðŸ‡µðŸ‡± Poland" ;;
            Portugal) echo "ðŸ‡µðŸ‡¹ Portugal" ;;
            Romania) echo "ðŸ‡·ðŸ‡´ Romania" ;;
            Serbia) echo "ðŸ‡·ðŸ‡¸ Serbia" ;;
            Singapore) echo "ðŸ‡¸ðŸ‡¬ Singapore" ;;
            Slovakia) echo "ðŸ‡¸ðŸ‡° Slovakia" ;;
            Slovenia) echo "ðŸ‡¸ðŸ‡® Slovenia" ;;
            "South") echo "ðŸ‡°ðŸ‡· South Korea" ;;
            Spain) echo "ðŸ‡ªðŸ‡¸ Spain" ;;
            Sweden) echo "ðŸ‡¸ðŸ‡ª Sweden" ;;
            Switzerland) echo "ðŸ‡¨ðŸ‡­ Switzerland" ;;
            Taiwan) echo "ðŸ‡¹ðŸ‡¼ Taiwan" ;;
            Thailand) echo "ðŸ‡¹ðŸ‡­ Thailand" ;;
            Turkey) echo "ðŸ‡¹ðŸ‡· Turkey" ;;
            Ukraine) echo "ðŸ‡ºðŸ‡¦ Ukraine" ;;
            UAE) echo "ðŸ‡¦ðŸ‡ª UAE" ;;
            UK|United) echo "ðŸ‡¬ðŸ‡§ UK" ;;
            USA) echo "ðŸ‡ºðŸ‡¸ USA" ;;
            Vietnam) echo "ðŸ‡»ðŸ‡³ Vietnam" ;;
            *) echo "ðŸŒ $country" ;;
        esac
    done | sort -u)

    CHOICE=$(echo -e "â† Back\n$COUNTRIES" | rofi -dmenu -i -p "Country" -theme-str 'window {width: 400px;}')

    [[ -z "$CHOICE" || "$CHOICE" == "â† Back" ]] && exec "$0"

    COUNTRY=$(echo "$CHOICE" | sed 's/^[^ ]* //')
    connect_server "$COUNTRY"
}

# Main
EXIT_NODE=$(get_exit_node)

if [[ -n "$EXIT_NODE" && "$EXIT_NODE" != "null" ]]; then
    # Connected
    if [[ "$EXIT_NODE" == *"mullvad"* ]]; then
        STATUS="ðŸŸ¢ $EXIT_NODE"
    else
        STATUS="ðŸŸ¡ $EXIT_NODE"
    fi
    OPTIONS="âœ– Disconnect
ðŸŒ Change Server...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$STATUS"
else
    # Disconnected
    OPTIONS="âš¡ Fastest Server
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ‡©ðŸ‡ª Germany
ðŸ‡³ðŸ‡± Netherlands
ðŸ‡¸ðŸ‡ª Sweden
ðŸ‡ºðŸ‡¸ USA
ðŸ‡¬ðŸ‡§ UK
ðŸ‡¨ðŸ‡­ Switzerland
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸŒ All Servers..."
fi

CHOICE=$(echo -e "$OPTIONS" | rofi -dmenu -i -p "VPN" -theme-str 'window {width: 400px;}')

case "$CHOICE" in
    "âœ– Disconnect") disconnect_vpn ;;
    *"Fastest"*)
        SERVER=$(tailscale exit-node list 2>/dev/null | grep -i "mullvad" | head -20 | shuf -n1 | awk '{print $1}')
        [[ -n "$SERVER" ]] && tailscale set --exit-node="$SERVER" && notify-send "VPN" "Connecting..." -t 2000
        ;;
    *"Germany"*) connect_server "germany" ;;
    *"Netherlands"*) connect_server "netherlands" ;;
    *"Sweden"*) connect_server "sweden" ;;
    *"USA"*) connect_server "usa" ;;
    *"UK"*) connect_server "united kingdom" ;;
    *"Switzerland"*) connect_server "switzerland" ;;
    *"All Servers"*|*"Change Server"*) show_all_servers ;;
esac
