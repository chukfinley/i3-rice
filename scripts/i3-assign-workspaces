#!/bin/bash
# Dynamically assign workspace ranges to connected outputs
# Generates i3 config, reloads, and moves existing workspaces

CONFIG="$HOME/.config/regolith3/i3/config.d/90_workspace_outputs"

# Get active outputs sorted by position (left-to-right, top-to-bottom)
mapfile -t OUTPUTS < <(i3-msg -t get_outputs | jq -r '.[] | select(.active) | "\(.rect.x) \(.rect.y) \(.name)"' | sort -n -k1 -k2 | awk '{print $3}')

NUM_OUTPUTS=${#OUTPUTS[@]}

# Generate workspace-to-output assignments
{
    echo "# Auto-generated by i3-assign-workspaces â€” do not edit"
    for i in "${!OUTPUTS[@]}"; do
        offset=$((i * 10))
        for ws in $(seq 1 9); do
            echo "workspace $((offset + ws)) output ${OUTPUTS[$i]}"
        done
        echo ""
    done
} > "$CONFIG"

i3-msg reload

# Move existing workspaces to their correct outputs
# Also move orphaned workspaces from disconnected monitors to the last output
sleep 0.3
LAST_OUTPUT="${OUTPUTS[$((NUM_OUTPUTS - 1))]}"

for ws_info in $(i3-msg -t get_workspaces | jq -r '.[] | "\(.name):\(.output)"'); do
    ws="${ws_info%%:*}"
    current_output="${ws_info##*:}"

    # Determine correct output for this workspace number
    if [[ "$ws" =~ ^[0-9]+$ ]]; then
        idx=$(( (ws - 1) / 10 ))
        if (( idx >= NUM_OUTPUTS )); then
            target="$LAST_OUTPUT"
        else
            target="${OUTPUTS[$idx]}"
        fi

        if [[ "$current_output" != "$target" ]]; then
            i3-msg "workspace $ws; move workspace to output $target" >/dev/null
        fi
    fi
done
