#!/bin/bash
# Dynamically assign workspace ranges to connected outputs
# Moves existing workspaces first, then generates config and reloads

CONFIG="$HOME/.config/regolith3/i3/config.d/90_workspace_outputs"

# Get active outputs with eDP-1 (laptop) always first, then others by position
mapfile -t OUTPUTS < <(i3-msg -t get_outputs | jq -r '.[] | select(.active) | "\(.rect.x) \(.rect.y) \(.name)"' | awk '{
    if ($3 ~ /^eDP/) print "0 0 " $3; else print "1 " $1 " " $2 " " $3
}' | sort -n -k1 -k2 -k3 | awk '{print $NF}')

NUM_OUTPUTS=${#OUTPUTS[@]}
LAST_OUTPUT="${OUTPUTS[$((NUM_OUTPUTS - 1))]}"

# Move existing workspaces to their correct outputs BEFORE reload
FOCUSED=$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused) | .name')

for ws_info in $(i3-msg -t get_workspaces | jq -r '.[] | "\(.name):\(.output)"'); do
    ws="${ws_info%%:*}"
    current_output="${ws_info##*:}"

    if [[ "$ws" =~ ^[0-9]+$ ]]; then
        idx=$(( (ws - 1) / 10 ))
        if (( idx >= NUM_OUTPUTS )); then
            target="$LAST_OUTPUT"
        else
            target="${OUTPUTS[$idx]}"
        fi

        if [[ "$current_output" != "$target" ]]; then
            i3-msg "workspace $ws; move workspace to output $target" >/dev/null
        fi
    fi
done

# Restore focus
i3-msg "workspace $FOCUSED" >/dev/null

# Generate workspace-to-output config
{
    echo "# Auto-generated by i3-assign-workspaces â€” do not edit"
    for i in "${!OUTPUTS[@]}"; do
        offset=$((i * 10))
        for ws in $(seq 1 9); do
            echo "workspace $((offset + ws)) output ${OUTPUTS[$i]}"
        done
        echo ""
    done
} > "$CONFIG"

i3-msg reload
